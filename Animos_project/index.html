<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é˜²ç½ãƒãƒ³ã‚¿ãƒ¼</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        if (typeof L === "undefined") {
            document.write("<p style=\"padding:20px;font-size:16px;\">åœ°å›³ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚</p>");
        }
    </script>

    <style>
        /* --- åŸºæœ¬ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- ãƒœã‚¿ãƒ³é¡ã®ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
        #download-btn {
            position: absolute; top: 10px; right: 10px; z-index: 999;
            background-color: white; padding: 10px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold;
            cursor: pointer; border: 2px solid #2ecc71; color: #2ecc71;
        }
        #nav-btn {
            position: absolute; top: 10px; left: 10px; z-index: 999;
            background-color: white; padding: 10px 14px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold;
            cursor: pointer; border: 2px solid #3498db; color: #3498db;
        }
        #gsi-load-btn {
            position: absolute; top: 55px; left: 10px; z-index: 999;
            background-color: white; padding: 10px 14px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 13px; font-weight: bold;
            cursor: pointer; border: 2px solid #9b59b6; color: #9b59b6;
        }
        #csv-shelter-btn {
            position: absolute; top: 100px; left: 10px; z-index: 999;
            background-color: white; padding: 10px 14px; border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 13px; font-weight: bold;
            cursor: pointer; border: 2px solid #e67e22; color: #e67e22;
        }
        /* iPhoneå¯¾å¿œï¼šãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ•ã‚©ãƒ¼ãƒ ã¯éè¡¨ç¤ºã«ã—ã¦ãŠã */
        #csv-shelter-input { display: none; }

        /* --- ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ‘ãƒãƒ« --- */
        #route-info {
            display: none; position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 999; background-color: white; padding: 12px 20px; border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3); font-size: 14px; max-width: 90%;
        }
        #route-info .route-close { margin-left: 10px; cursor: pointer; color: #e74c3c; font-weight: bold; }

        /* --- æŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰ --- */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background-color: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        h2 { margin-top: 0; font-size: 18px; text-align: center; }
        label { display: block; margin-top: 10px; font-weight: bold; font-size: 14px; }
        select, input[type="text"], textarea { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        textarea { height: 60px; }
        #preview-area { margin-top: 10px; text-align: center; }
        #preview-img { max-width: 100%; max-height: 150px; display: none; border-radius: 5px; border: 1px solid #ddd; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
        button { padding: 10px 20px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; }
        .btn-save { background-color: #2ecc71; color: white; flex: 1; margin-left: 10px; }
        .btn-cancel { background-color: #95a5a6; color: white; }
        .btn-delete { background-color: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; margin-top: 5px; font-size: 12px; }
        .popup-img { width: 200px; height: auto; margin-top: 5px; border-radius: 4px; }
        .star { color: #f1c40f; font-size: 1.2em; }
    </style>
</head>
<body>

    <button id="download-btn" onclick="downloadCSV()">ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ä¿å­˜(CSV)</button>
    <button id="nav-btn" onclick="navigateToNearestShelter()">ğŸ§­ æœ€å¯„ã‚Šé¿é›£æ‰€ã¸ãƒŠãƒ“</button>
    <button id="gsi-load-btn" onclick="loadGSIShelters()">ğŸ› å›½åœŸåœ°ç†é™¢ã®é¿é›£æ‰€ã‚’è¿½åŠ </button>
    <button id="csv-shelter-btn" onclick="document.getElementById('csv-shelter-input').click()">ğŸ“„ æŒ‡å®šé¿é›£æ‰€CSVã‚’è¿½åŠ </button>
    
    <input type="file" id="csv-shelter-input" onchange="onShelterCSVSelected(event)">
    
    <div id="route-info"><span id="route-text"></span><span class="route-close" onclick="clearRoute()">âœ• é–‰ã˜ã‚‹</span></div>

    <div id="map"></div>

    <div id="modal">
        <div class="modal-content">
            <h2>ğŸ“ æ–°ã—ã„æŠ•ç¨¿</h2>
            <label>ãƒ”ãƒ³ã®ç¨®é¡</label>
            <select id="input-type">
                <option value="danger">ğŸš¨ å±é™ºï¼ˆèµ¤ï¼‰</option>
                <option value="safe">ğŸ’™ å®‰å¿ƒï¼ˆé’ï¼‰</option>
                <option value="notice">ğŸ’¡ æ°—ã¥ãï¼ˆé»„ï¼‰</option>
            </select>
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="input-category">
                <option value="åœ°éœ‡">åœ°éœ‡ãƒ»å»ºç‰©å€’å£Š</option>
                <option value="å¤§é›¨">å¤§é›¨ãƒ»æµ¸æ°´</option>
                <option value="åœŸç ‚">åœŸç ‚ç½å®³</option>
                <option value="æ®µå·®">é“è·¯ã®æ®µå·®ãƒ»å±é™º</option>
                <option value="æš—ã„é“">æš—ã„é“ãƒ»è¡—ç¯ãªã—</option>
                <option value="æ–½è¨­">é¿é›£å ´æ‰€ãƒ»æ–½è¨­</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <label>å±é™ºãƒ¬ãƒ™ãƒ«ï¼ˆé‡è¦åº¦ï¼‰</label>
            <select id="input-level">
                <option value="1">â˜…â˜†â˜†â˜†â˜† (ãƒ¬ãƒ™ãƒ«1)</option>
                <option value="2">â˜…â˜…â˜†â˜†â˜† (ãƒ¬ãƒ™ãƒ«2)</option>
                <option value="3" selected>â˜…â˜…â˜…â˜†â˜† (ãƒ¬ãƒ™ãƒ«3)</option>
                <option value="4">â˜…â˜…â˜…â˜…â˜† (ãƒ¬ãƒ™ãƒ«4)</option>
                <option value="5">â˜…â˜…â˜…â˜…â˜… (ãƒ¬ãƒ™ãƒ«5)</option>
            </select>
            <label>å†™çœŸ</label>
            <input type="file" id="input-photo" accept="image/*" onchange="previewPhoto()">
            <div id="preview-area"><img id="preview-img" src=""></div>
            <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea id="input-comment" placeholder="çŠ¶æ³ã‚’è©³ã—ãæ›¸ã„ã¦ãã ã•ã„"></textarea>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save" onclick="saveData()">ç™»éŒ²ã™ã‚‹</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. åœ°å›³ã®åˆæœŸè¨­å®š ---
        var map = L.map('map', { minZoom: 5, maxZoom: 19 }).setView([34.18583, 131.47139], 15);
        var markerGroup = L.layerGroup().addTo(map); // ãƒ”ãƒ³ã‚’ã¾ã¨ã‚ã¦ç®¡ç†ã™ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—
        var routeLayer = null; // ãƒ«ãƒ¼ãƒˆç·š
        
        // å¤‰æ•°
        var currentLat = 0, currentLng = 0;
        var uploadedPhotoData = null;
        var savedMarkers = [];
        var userLat = null, userLng = null;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap contributors' }).addTo(map);

        // --- 2. ã‚¢ã‚¤ã‚³ãƒ³è¨­å®š ---
        var icons = {
            danger: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            safe: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            notice: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] })
        };

        // --- 3. ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ ---
        loadMarkers();

        // --- 4. æŠ•ç¨¿æ©Ÿèƒ½ ---
        map.on('click', function(e) {
            currentLat = e.latlng.lat; currentLng = e.latlng.lng;
            document.getElementById('input-comment').value = "";
            document.getElementById('input-photo').value = "";
            document.getElementById('preview-img').style.display = 'none';
            uploadedPhotoData = null;
            document.getElementById('modal').style.display = 'flex';
        });

        function previewPhoto() {
            var file = document.getElementById('input-photo').files[0];
            var reader = new FileReader();
            reader.onloadend = function() {
                var preview = document.getElementById('preview-img');
                preview.src = reader.result;
                preview.style.display = "block";
                uploadedPhotoData = reader.result;
            }
            if (file) { reader.readAsDataURL(file); }
        }

        function saveData() {
            var type = document.getElementById('input-type').value;
            var category = document.getElementById('input-category').value;
            var level = document.getElementById('input-level').value;
            var comment = document.getElementById('input-comment').value;
            var newMarkerData = { id: Date.now(), lat: currentLat, lng: currentLng, type: type, category: category, level: level, comment: comment, photo: uploadedPhotoData };
            savedMarkers.push(newMarkerData);
            saveToLocalStorage();
            addMarkerToMap(newMarkerData);
            closeModal();
        }

        function addMarkerToMap(data) {
            var level = data.level ? data.level : "3";
            var stars = "â˜…".repeat(level) + "â˜†".repeat(5 - level);
            var popupContent = `<b>ã€${data.category}ã€‘</b><br><span class="star">${stars}</span><br>${data.comment}`;
            if (data.photo) popupContent += `<br><img src="${data.photo}" class="popup-img">`;
            var safeId = String(data.id).replace(/&/g, "&amp;").replace(/"/g, "&quot;");
            popupContent += '<br><button type="button" class="btn-delete" data-marker-id="' + safeId + '">ã‚´ãƒŸç®±ï¼ˆå‰Šé™¤ï¼‰</button>';
            
            // â˜…markerGroupã«è¿½åŠ ã™ã‚‹ã“ã¨ã§ä¸€æ‹¬å‰Šé™¤ã‚’å¯èƒ½ã«ã™ã‚‹
            var marker = L.marker([data.lat, data.lng], {icon: icons[data.type]}).addTo(markerGroup).bindPopup(popupContent);
            marker.dataId = data.id;
        }

        function saveToLocalStorage() { localStorage.setItem('bousaiMarkers', JSON.stringify(savedMarkers)); }
        
        function loadMarkers() {
            var data = localStorage.getItem('bousaiMarkers');
            if (data) {
                savedMarkers = JSON.parse(data);
                markerGroup.clearLayers(); // åˆæœŸåŒ–
                savedMarkers.forEach(addMarkerToMap);
            }
        }

        // â˜…ç”»é¢ãƒªã‚»ãƒƒãƒˆãªã—ã®é«˜é€Ÿå‰Šé™¤
        function deleteMarker(id) {
            if (!confirm("æœ¬å½“ã«ã“ã®ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            savedMarkers = savedMarkers.filter(function(m) { return String(m.id) !== String(id); });
            saveToLocalStorage();
            markerGroup.clearLayers(); // å…¨æ¶ˆã—ã—ã¦
            savedMarkers.forEach(addMarkerToMap); // ã™ãæç”»
        }

        document.addEventListener("click", function(e) {
            if (e.target && e.target.classList.contains("btn-delete")) {
                var id = e.target.getAttribute("data-marker-id");
                if (id != null) deleteMarker(id);
            }
        });
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // --- 5. ç¾åœ¨åœ°å–å¾— ---
        map.locate({setView: true, maxZoom: 16});
        map.on('locationfound', function(e) {
            userLat = e.latlng.lat; userLng = e.latlng.lng;
            // å¤ã„å††ãŒã‚ã‚Œã°æ¶ˆã™
            map.eachLayer(function(layer){ if(layer instanceof L.Circle && layer.options.color === undefined) map.removeLayer(layer); });
            L.circle(e.latlng, e.accuracy / 2).addTo(map);
        });

        // --- 6. è³¢ã„ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå·¦å³æ¢ç´¢ & å¤§å›ã‚Šé˜²æ­¢ï¼‰ ---
        function getDistanceKm(lat1, lng1, lat2, lng2) {
            var R = 6371;
            var dLat = (lat2 - lat1) * Math.PI / 180;
            var dLng = (lng2 - lng1) * Math.PI / 180;
            var a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)*Math.sin(dLng/2);
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function getDangerMarkers() {
            return savedMarkers.filter(function(m) {
                if (m.category === "æ–½è¨­") return false;
                if (m.type === "danger") return true;
                var lv = parseInt(m.level, 10);
                return !isNaN(lv) && lv >= 3;
            });
        }

        function routePassesNearDanger(latlngs, dangerMarkers, thresholdKm) {
            var near = [];
            for (var d = 0; d < dangerMarkers.length; d++) {
                var dm = dangerMarkers[d];
                for (var i = 0; i < latlngs.length; i++) {
                    var distKm = getDistanceKm(dm.lat, dm.lng, latlngs[i][0], latlngs[i][1]);
                    if (distKm < thresholdKm) { near.push(dm); break; }
                }
            }
            return { near: near.length > 0, dangers: near };
        }

        function computeViaPoint(startLat, startLng, endLat, endLng, dangersNear, offsetVal) {
            if (!dangersNear || dangersNear.length === 0) return null;
            var cLat = 0, cLng = 0;
            dangersNear.forEach(function(d) { cLat += d.lat; cLng += d.lng; });
            cLat /= dangersNear.length;
            cLng /= dangersNear.length;
            var midLat = (startLat + endLat) / 2; var midLng = (startLng + endLng) / 2;
            var dx = midLng - cLng; var dy = midLat - cLat;
            var len = Math.sqrt(dx*dx + dy*dy);
            if (len === 0) { dx = 0.001; len = 0.001; }
            return { lat: midLat + (dy / len) * offsetVal, lng: midLng + (dx / len) * offsetVal };
        }

        function fetchRoute(waypoints) {
            var pts = waypoints.map(function(w) { return w.lng + "," + w.lat; });
            var url = "https://router.project-osrm.org/route/v1/driving/" + pts.join(";") + "?overview=full&geometries=geojson";
            return fetch(url).then(function(res) { return res.json(); });
        }

        function applyRouteOnMap(data, msgSuffix, isDangerous) {
            if (data.code !== "Ok" || !data.routes || !data.routes[0]) return null;
            var route = data.routes[0];
            var latlngs = route.geometry.coordinates.map(function(c) { return [c[1], c[0]]; });
            if (routeLayer) map.removeLayer(routeLayer);
            var style = isDangerous ? {color: '#e74c3c', dashArray: '5, 10', weight: 5} : {color: '#3498db', weight: 5, opacity: 0.8};
            routeLayer = L.polyline(latlngs, style).addTo(map);
            map.fitBounds(routeLayer.getBounds(), { padding: [40, 40] });
            var dist = (route.distance / 1000).toFixed(2);
            var dur = Math.round(route.duration / 60);
            document.getElementById("route-text").textContent = "é¿é›£æ‰€ã¾ã§ ç´„" + dist + "kmãƒ»" + dur + "åˆ†" + (msgSuffix || "");
            document.getElementById("route-info").style.display = "block";
            return { latlngs: latlngs, route: route };
        }

        window.navigateToNearestShelter = async function() {
            if (userLat == null || userLng == null) return alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã€‚");
            var shelters = savedMarkers.filter(function(m) { return m.category === "æ–½è¨­"; });
            if (shelters.length === 0) return alert("é¿é›£æ‰€ãƒ”ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");

            var btn = document.getElementById("nav-btn"); btn.disabled = true; btn.textContent = "â­® å®‰å…¨ãƒ«ãƒ¼ãƒˆæ¢ç´¢ä¸­...";
            shelters.sort(function(a, b) { return getDistanceKm(userLat, userLng, a.lat, a.lng) - getDistanceKm(userLat, userLng, b.lat, b.lng); });
            var dangerMarkers = getDangerMarkers();
            var DANGER_THRESHOLD_KM = 0.020; // åˆ¤å®šè·é›¢20m
            var foundSafeRoute = false;
            var maxCheck = Math.min(shelters.length, 3);

            for (var i = 0; i < maxCheck; i++) {
                var target = shelters[i]; var targetName = (target.comment || "é¿é›£æ‰€").split("ï¼")[0];
                btn.textContent = "æ¢ç´¢ä¸­: " + targetName + "...";
                var start = { lat: userLat, lng: userLng }; var end = { lat: target.lat, lng: target.lng };
                try {
                    var data = await fetchRoute([start, end]);
                    if (data.code === "Ok" && data.routes) {
                        var originalRoute = data.routes[0];
                        var check = routePassesNearDanger(originalRoute.geometry.coordinates.map(c => [c[1], c[0]]), dangerMarkers, DANGER_THRESHOLD_KM);
                        if (!check.near) {
                            applyRouteOnMap(data, "ï¼ˆæœ€çŸ­ãƒ»å®‰å…¨ï¼‰", false);
                            alert("âœ… æœ€ã‚‚è¿‘ã„ã€" + targetName + "ã€‘ã¸ã®å®‰å…¨ãªãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚");
                            foundSafeRoute = true; break;
                        } 
                        
                        console.log("æœ€çŸ­ã¯å±é™ºã€‚è¿‚å›ãƒ«ãƒ¼ãƒˆè¨ˆç®—ä¸­...");
                        var tryOffsets = [0.003, -0.003]; // å³ã¨å·¦ã‚’è©¦ã™
                        for (var k = 0; k < tryOffsets.length; k++) {
                            var via = computeViaPoint(start.lat, start.lng, end.lat, end.lng, check.dangers, tryOffsets[k]);
                            if (via) {
                                var dataDetour = await fetchRoute([start, via, end]);
                                if (dataDetour.code === "Ok" && dataDetour.routes) {
                                    var detourRoute = dataDetour.routes[0];
                                    if (detourRoute.distance > originalRoute.distance * 1.8) continue; // é ã™ãã‚‹å ´åˆã¯æ¬¡ã¸
                                    var checkD = routePassesNearDanger(detourRoute.geometry.coordinates.map(c => [c[1], c[0]]), dangerMarkers, DANGER_THRESHOLD_KM);
                                    if (!checkD.near) {
                                        applyRouteOnMap(dataDetour, "ï¼ˆè¿‚å›ãƒ«ãƒ¼ãƒˆï¼‰", false);
                                        var dir = tryOffsets[k] > 0 ? "ï¼ˆæ±å´ï¼‰" : "ï¼ˆè¥¿å´ï¼‰";
                                        alert("âš ï¸ æœ€çŸ­ãƒ«ãƒ¼ãƒˆä¸Šã«å±é™ºç®‡æ‰€ãŒã‚ã‚Šã¾ã™ã€‚\n\nâœ… å±é™ºã‚’é¿ã‘ãŸãƒ«ãƒ¼ãƒˆ" + dir + "ã‚’è¡¨ç¤ºã—ã¾ã—ãŸã€‚");
                                        foundSafeRoute = true; break;
                                    }
                                }
                            }
                        }
                        if (foundSafeRoute) break;
                    }
                } catch(e) { console.error(e); }
            }
            if (!foundSafeRoute) {
                alert("å®‰å…¨ãªè¿‚å›ãƒ«ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\næ³¨æ„ã—ã¦æœ€çŸ­ãƒ«ãƒ¼ãƒˆã‚’é€²ã‚“ã§ãã ã•ã„ã€‚");
                var t = shelters[0];
                fetchRoute([{lat:userLat, lng:userLng}, {lat:t.lat, lng:t.lng}]).then(d => applyRouteOnMap(d, "ï¼ˆâ€»å±é™ºã‚ã‚Šæ³¨æ„ï¼ï¼‰", true));
            }
            btn.disabled = false; btn.textContent = "ğŸ§­ æœ€å¯„ã‚Šé¿é›£æ‰€ã¸ãƒŠãƒ“";
        };

        window.clearRoute = function() { if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; } document.getElementById("route-info").style.display = "none"; };

        // --- 7. CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ & å›½åœŸåœ°ç†é™¢ ---
        window.downloadCSV = function() {
            if (savedMarkers.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            var csv = "ç·¯åº¦,çµŒåº¦,ç¨®é¡,ã‚«ãƒ†ã‚´ãƒª,ãƒ¬ãƒ™ãƒ«,ã‚³ãƒ¡ãƒ³ãƒˆ,æ—¥æ™‚\n";
            savedMarkers.forEach(function(m) {
                var d = (typeof m.id === 'number') ? new Date(m.id).toLocaleString() : "å›½åœŸåœ°ç†é™¢";
                var clean = (m.comment || "").replace(/,/g, " ").replace(/\n/g, " ");
                csv += `${m.lat},${m.lng},${m.type},${m.category},${m.level||""},${clean},${d}\n`;
            });
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "bousai_data.csv";
            link.click();
        };

        function parseCSVLine(line) { var out=[],cur="",inQ=false; for(var i=0;i<line.length;i++){ var c=line[i]; if(c==='"')inQ=!inQ; else if(c===','&&!inQ){out.push(cur);cur="";}else cur+=c;} out.push(cur); return out; }
        function findCol(cells, names) { for(var i=0;i<cells.length;i++){ var v=(cells[i]||"").trim(); for(var n=0;n<names.length;n++)if(v.indexOf(names[n])!==-1)return i; } return -1; }
        
        function processShelterCSV(raw, btn) {
            if (raw.charCodeAt(0) === 0xFEFF) raw = raw.slice(1);
            var lines = raw.split(/\r?\n/).filter(l => l.trim().length > 0);
            if (lines.length < 2) { btn.disabled=false; btn.textContent="ğŸ“„ æŒ‡å®šé¿é›£æ‰€CSVã‚’è¿½åŠ "; return alert("æœ‰åŠ¹ãªCSVã§ã¯ã‚ã‚Šã¾ã›ã‚“"); }
            var header = parseCSVLine(lines[0]);
            var colName = findCol(header, ["æ–½è¨­ãƒ»å ´æ‰€å","æ–½è¨­å"]), colLat = findCol(header, ["ç·¯åº¦"]), colLng = findCol(header, ["çµŒåº¦"]);
            if (colLat < 0 || colLng < 0) { btn.disabled=false; btn.textContent="ğŸ“„ æŒ‡å®šé¿é›£æ‰€CSVã‚’è¿½åŠ "; return alert("ç·¯åº¦ãƒ»çµŒåº¦åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); }
            var existingIds = {}, added = 0;
            savedMarkers.forEach(m => { if(typeof m.id==="string" && m.id.indexOf("gsi_shelter_")===0) existingIds[m.id]=true; });
            for (var i = 1; i < lines.length; i++) {
                var cells = parseCSVLine(lines[i]), lat = parseFloat(cells[colLat]), lng = parseFloat(cells[colLng]);
                if (isNaN(lat) || isNaN(lng)) continue;
                var id = "gsi_shelter_row" + i;
                if (existingIds[id]) continue;
                var name = cells[colName] || "æŒ‡å®šé¿é›£æ‰€";
                var newData = { id: id, lat: lat, lng: lng, type: "safe", category: "æ–½è¨­", level: "3", comment: name, photo: null };
                savedMarkers.push(newData); addMarkerToMap(newData); added++;
            }
            saveToLocalStorage(); btn.disabled=false; btn.textContent="ğŸ“„ æŒ‡å®šé¿é›£æ‰€CSVã‚’è¿½åŠ "; alert("è¿½åŠ ä»¶æ•°: " + added);
        }

        window.onShelterCSVSelected = function(ev) {
            var file = ev.target.files[0]; if(!file) return; ev.target.value = "";
            var btn = document.getElementById("csv-shelter-btn"); btn.disabled = true; btn.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
            var reader = new FileReader();
            reader.onload = function(e) { processShelterCSV(e.target.result, btn); };
            reader.readAsText(file, "UTF-8");
        };

        // å›½åœŸåœ°ç†é™¢ãƒ¬ã‚¤ãƒ¤ãƒ¼
        function lngLatToTile(lng, lat, z) { var n = Math.pow(2, z), x = Math.floor((lng + 180) / 360 * n), y = Math.floor((1 - Math.log(Math.tan(lat * Math.PI / 180) + 1/Math.cos(lat * Math.PI / 180)) / Math.PI) / 2 * n); return { x: x, y: y, z: z }; }
        function getTilesInBounds(bounds, z) { var sw = bounds.getSouthWest(), ne = bounds.getNorthEast(), t1 = lngLatToTile(sw.lng, sw.lat, z), t2 = lngLatToTile(ne.lng, ne.lat, z), minX = Math.min(t1.x, t2.x), maxX = Math.max(t1.x, t2.x), minY = Math.min(t1.y, t2.y), maxY = Math.max(t1.y, t2.y), tiles = []; for (var x = minX; x <= maxX; x++) for (var y = minY; y <= maxY; y++) tiles.push({ x: x, y: y, z: z }); return tiles; }
        var GSI_TILE_LAYERS = ["skhb01","skhb02","skhb03","skhb04","skhb05","skhb06","skhb07","skhb08"];
        var GSI_BASE = "https://cyberjapandata.gsi.go.jp/xyz/";
        window.loadGSIShelters = function() {
            var btn = document.getElementById("gsi-load-btn"); btn.disabled = true; btn.textContent = "èª­ã¿è¾¼ã¿ä¸­...";
            var bounds = map.getBounds(), z = 14, tiles = getTilesInBounds(bounds, z), existingIds = {}, totalAdded = 0;
            savedMarkers.forEach(function(m) { if (typeof m.id==='string' && m.id.indexOf('gsi_')===0) existingIds[m.id] = true; });
            var layerIndex = 0, tileIndex = 0;
            function fetchNext() {
                if (layerIndex >= GSI_TILE_LAYERS.length) { saveToLocalStorage(); btn.disabled = false; btn.textContent = "ğŸ› å›½åœŸåœ°ç†é™¢ã®é¿é›£æ‰€ã‚’è¿½åŠ "; return alert("å®Œäº†: " + totalAdded + " ä»¶è¿½åŠ ã—ã¾ã—ãŸã€‚"); }
                var layer = GSI_TILE_LAYERS[layerIndex];
                if (tileIndex >= tiles.length) { layerIndex++; tileIndex = 0; return setTimeout(fetchNext, 100); }
                var t = tiles[tileIndex];
                fetch(GSI_BASE + layer + "/" + t.z + "/" + t.x + "/" + t.y + ".geojson")
                    .then(res => res.ok ? res.json() : null)
                    .then(geojson => {
                        if (geojson && geojson.features) {
                            geojson.features.forEach(f => {
                                var geom = f.geometry, prop = f.properties || {};
                                if (geom && geom.type === "Point") {
                                    var lng = geom.coordinates[0], lat = geom.coordinates[1], kid = prop["å…±é€šID"] || (lat.toFixed(5)+"_"+lng.toFixed(5)), key = "gsi_" + kid;
                                    if (!existingIds[key]) { existingIds[key] = true; var name = prop["æ–½è¨­ãƒ»å ´æ‰€å"] || "é¿é›£å ´æ‰€", newData = { id: key, lat: lat, lng: lng, type: "safe", category: "æ–½è¨­", level: "3", comment: name, photo: null }; savedMarkers.push(newData); addMarkerToMap(newData); totalAdded++; }
                                }
                            });
                        } tileIndex++; setTimeout(fetchNext, 80);
                    }).catch(() => { tileIndex++; setTimeout(fetchNext, 80); });
            }
            if (tiles.length === 0) { btn.disabled = false; btn.textContent = "ğŸ› å›½åœŸåœ°ç†é™¢ã®é¿é›£æ‰€ã‚’è¿½åŠ "; return alert("ç¯„å›²ã‚’åºƒã’ã¦ãã ã•ã„"); }
            fetchNext();
        };
    </script>
</body>
</html>