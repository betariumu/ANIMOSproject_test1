<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜²ç½ãƒãƒ³ã‚¿ãƒ¼ - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒŠãƒ“ç‰ˆ</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* --- ã‚¹ãƒãƒ›å¯¾å¿œUIï¼ˆç”»é¢ä¸‹ã«å›ºå®šï¼‰ --- */
        .ui-container {
            position: absolute; bottom: 30px; left: 10px; right: 10px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none; /* ãƒœã‚¿ãƒ³ä»¥å¤–ã¯åœ°å›³æ“ä½œã‚’é€šã™ */
        }
        .ui-btn {
            background-color: white; padding: 12px; border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); font-size: 14px; font-weight: bold;
            text-align: center; cursor: pointer; pointer-events: auto;
            border: 2px solid #ccc;
        }
        #nav-btn { border-color: #3498db; color: #3498db; }
        #stop-nav-btn { border-color: #e74c3c; color: #e74c3c; display: none; } /* ãƒŠãƒ“ä¸­ã®ã¿è¡¨ç¤º */
        
        /* å³ä¸Šã®ä¿å­˜ãƒœã‚¿ãƒ³ */
        #top-right-ui {
            position: absolute; top: 10px; right: 10px; z-index: 1000;
            display: flex; gap: 10px;
        }
        .icon-btn {
            background: white; width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); font-size: 20px; cursor: pointer;
        }

        /* ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ‘ãƒãƒ«ï¼ˆç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºï¼‰ */
        #route-info {
            display: none; position: absolute; top: 10px; left: 10px; right: 60px;
            z-index: 1000; background-color: rgba(255, 255, 255, 0.95);
            padding: 10px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            font-size: 14px; font-weight: bold;
        }

        /* éš ã—è¦ç´  */
        #csv-input, #gsi-btn, #csv-btn { display: none; } 

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        select, input, textarea { width: 100%; padding: 8px; margin-top: 5px; box-sizing: border-box; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn-save { background: #2ecc71; color: white; border: none; padding: 10px 20px; border-radius: 5px; flex: 1; margin-left: 10px; }
        .btn-cancel { background: #95a5a6; color: white; border: none; padding: 10px 20px; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="top-right-ui">
        <div class="icon-btn" onclick="downloadCSV()">ğŸ’¾</div>
        <div class="icon-btn" onclick="toggleMenu()">âš™ï¸</div>
    </div>

    <div id="route-info">
        <span id="route-text"></span>
    </div>

    <div class="ui-container">
        <div id="nav-btn" class="ui-btn" onclick="startNavigation()">ğŸ§­ æœ€å¯„ã‚Šé¿é›£æ‰€ã¸ãƒŠãƒ“é–‹å§‹</div>
        <div id="stop-nav-btn" class="ui-btn" onclick="stopNavigation()">â¹ ãƒŠãƒ“çµ‚äº†</div>
    </div>

    <input type="file" id="csv-input" onchange="onShelterCSVSelected(event)">
    <div id="settings-menu" style="display:none; position:absolute; top:60px; right:10px; background:white; padding:10px; border-radius:5px; z-index:1001; box-shadow:0 2px 10px rgba(0,0,0,0.2);">
        <button onclick="document.getElementById('csv-input').click()">ğŸ“„ CSVè¿½åŠ </button>
        <button onclick="loadGSIShelters(false)">ğŸ› å›½åœŸåœ°ç†é™¢ãƒ‡ãƒ¼ã‚¿</button>
    </div>

    <div id="map"></div>

    <div id="modal">
        <div class="modal-content">
            <h3>ğŸ“ æ–°ã—ã„æŠ•ç¨¿</h3>
            <label>ç¨®é¡</label>
            <select id="input-type">
                <option value="danger">ğŸš¨ å±é™ºï¼ˆèµ¤ï¼‰</option>
                <option value="safe">ğŸ’™ å®‰å¿ƒï¼ˆé’ï¼‰</option>
                <option value="notice">ğŸ’¡ æ°—ã¥ãï¼ˆé»„ï¼‰</option>
            </select>
            <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea id="input-comment"></textarea>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save" onclick="saveData()">ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. åˆæœŸè¨­å®š ---
        var map = L.map('map', { zoomControl: false }).setView([34.685, 135.805], 15); // åˆæœŸä½ç½®ã¯å¥ˆè‰¯å‘¨è¾º
        var markerGroup = L.layerGroup().addTo(map);
        var routeLayer = null;
        var watchId = null; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ç”¨ID
        var userMarker = null;
        var currentDest = null; // ç¾åœ¨ã®ç›®çš„åœ°
        var savedMarkers = [];
        var isNavigating = false;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

        // ã‚¢ã‚¤ã‚³ãƒ³
        var icons = {
            danger: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            safe: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            notice: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] })
        };

        // --- 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®æƒ…å ± ---
        function startTracking() {
            if (navigator.geolocation) {
                // watchPositionã§å‹•ãã‚’ç›£è¦–
                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        var lat = pos.coords.latitude;
                        var lng = pos.coords.longitude;
                        var acc = pos.coords.accuracy;

                        // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
                        if (userMarker) map.removeLayer(userMarker);
                        userMarker = L.circle([lat, lng], { radius: acc / 2, color: 'blue', fillColor: '#3498db', fillOpacity: 0.3 }).addTo(map);

                        // åˆå›ã ã‘ã‚ºãƒ¼ãƒ 
                        if (!isNavigating) {
                            // map.setView([lat, lng], 16); 
                        }

                        // ãƒŠãƒ“ä¸­ãªã‚‰ãƒ«ãƒ¼ãƒˆå†è¨ˆç®—ï¼ˆã“ã“ãŒãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒŠãƒ“ã®è‚ï¼ï¼‰
                        if (isNavigating && currentDest) {
                            calculateRoute(lat, lng, currentDest.lat, currentDest.lng);
                        }
                    },
                    (err) => console.warn("GPS Error: " + err.message),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }
        startTracking();
        
        // èµ·å‹•æ™‚ã®ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
        loadMarkers();
        loadGSIShelters(true); // è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
        autoLoadRepositoryCSV(); // CSVè‡ªå‹•ãƒ­ãƒ¼ãƒ‰

        // --- 3. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ï¼ˆå¼·åŒ–ç‰ˆï¼‰ ---
        function startNavigation() {
            if (!userMarker) return alert("ç¾åœ¨åœ°ã‚’å–å¾—ä¸­...å°‘ã€…ãŠå¾…ã¡ãã ã•ã„");
            
            var shelters = savedMarkers.filter(m => m.category === "æ–½è¨­");
            if (shelters.length === 0) return alert("é¿é›£æ‰€ãƒ”ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“");

            isNavigating = true;
            document.getElementById('nav-btn').style.display = 'none';
            document.getElementById('stop-nav-btn').style.display = 'block';
            
            // ä¸€ç•ªè¿‘ã„é¿é›£æ‰€ã‚’æ¢ã™
            var uLat = userMarker.getLatLng().lat;
            var uLng = userMarker.getLatLng().lng;
            shelters.sort((a, b) => getDist(uLat, uLng, a.lat, a.lng) - getDist(uLat, uLng, b.lat, b.lng));
            
            currentDest = shelters[0]; // æœ€å¯„ã‚Šã‚’ç›®çš„åœ°ã«è¨­å®š
            calculateRoute(uLat, uLng, currentDest.lat, currentDest.lng);
        }

        function stopNavigation() {
            isNavigating = false;
            currentDest = null;
            if (routeLayer) map.removeLayer(routeLayer);
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('nav-btn').style.display = 'block';
            document.getElementById('stop-nav-btn').style.display = 'none';
        }

        async function calculateRoute(startLat, startLng, endLat, endLng) {
            // å±é™ºåˆ¤å®šè·é›¢ã‚’ã€Œ40mã€ã«æ‹¡å¤§ï¼ˆã‚¹ãƒãƒ›ã§ã®å¼·è¡Œçªç ´ã‚’é˜²ãï¼‰
            var DANGER_THRESHOLD = 0.04; 
            var dangers = getDangerMarkers();

            try {
                // 1. ã¾ãšæœ€çŸ­ãƒ«ãƒ¼ãƒˆ
                var url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
                var res = await fetch(url);
                var json = await res.json();
                
                if (!json.routes || json.routes.length === 0) return;
                var route = json.routes[0];
                var coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

                // 2. å±é™ºåˆ¤å®š
                var isSafe = !checkDanger(coords, dangers, DANGER_THRESHOLD);

                if (isSafe) {
                    drawRoute(coords, '#3498db'); // å®‰å…¨ãªã‚‰é’
                    updateInfo("âœ… å®‰å…¨ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ä¸­", route.duration);
                } else {
                    // 3. å±é™ºãªã‚‰è¿‚å›è¨ˆç®—ï¼ˆã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’åºƒã’ã¦è¤‡æ•°è©¦è¡Œï¼‰
                    var detour = await findDetour(startLat, startLng, endLat, endLng, dangers);
                    if (detour) {
                        drawRoute(detour.coords, '#2ecc71'); // è¿‚å›æˆåŠŸãªã‚‰ç·‘
                        updateInfo("âš ï¸ å±é™ºå›é¿ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ä¸­", detour.duration);
                    } else {
                        drawRoute(coords, '#e74c3c', true); // ã©ã†ã—ã¦ã‚‚ãƒ€ãƒ¡ãªã‚‰èµ¤ç‚¹ç·š
                        updateInfo("âš ï¸ å±é™ºã‚ã‚Šï¼æ³¨æ„ã—ã¦é€²è¡Œ", route.duration);
                    }
                }
            } catch (e) { console.error(e); }
        }

        // è¿‚å›ãƒ«ãƒ¼ãƒˆã‚’æ¢ã™ï¼ˆå·¦å³å¤§ããæŒ¯ã‚‹ï¼‰
        async function findDetour(sLat, sLng, eLat, eLng, dangers) {
            var offsets = [0.005, -0.005, 0.01, -0.01]; // ç´„500m, 1km ã®å·¦å³
            for (let off of offsets) {
                var via = computeVia(sLat, sLng, eLat, eLng, dangers, off);
                if (!via) continue;
                
                var url = `https://router.project-osrm.org/route/v1/driving/${sLng},${sLat};${via.lng},${via.lat};${eLng},${eLat}?overview=full&geometries=geojson`;
                try {
                    var res = await fetch(url);
                    var json = await res.json();
                    if (json.routes && json.routes[0]) {
                        var r = json.routes[0];
                        var c = r.geometry.coordinates.map(p => [p[1], p[0]]);
                        if (!checkDanger(c, dangers, 0.04)) return { coords: c, duration: r.duration };
                    }
                } catch(e) {}
            }
            return null;
        }

        function drawRoute(latlngs, color, dash) {
            if (routeLayer) map.removeLayer(routeLayer);
            var style = { color: color, weight: 6, opacity: 0.8 };
            if (dash) style.dashArray = '10, 10';
            routeLayer = L.polyline(latlngs, style).addTo(map);
            // ãƒŠãƒ“ä¸­ã¯ã‚ºãƒ¼ãƒ ã—ã™ããªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«å‹•ã‹ã›ã‚‹ã‚ˆã†ã«ï¼‰
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function getDist(lat1, lng1, lat2, lng2) {
            var R = 6371; var dLat = (lat2-lat1)*Math.PI/180; var dLng = (lng2-lng1)*Math.PI/180;
            var a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getDangerMarkers() { return savedMarkers.filter(m => m.type === 'danger' || (m.level && parseInt(m.level) >= 3)); }
        function checkDanger(coords, dangers, th) {
            return dangers.some(d => coords.some(c => getDist(d.lat, d.lng, c[0], c[1]) < th));
        }
        function computeVia(sLat, sLng, eLat, eLng, dangers, off) {
            // å˜ç´”ãªé‡å¿ƒè¨ˆç®—
            var cLat=0, cLng=0; dangers.forEach(d=>{cLat+=d.lat; cLng+=d.lng});
            cLat/=dangers.length; cLng/=dangers.length;
            var mLat=(sLat+eLat)/2, mLng=(sLng+eLng)/2;
            var dx=mLng-cLng, dy=mLat-cLat; var len=Math.sqrt(dx*dx+dy*dy) || 0.001;
            return { lat: mLat+(dy/len)*off, lng: mLng+(dx/len)*off };
        }
        function updateInfo(msg, sec) {
            var min = Math.round(sec / 60);
            document.getElementById('route-info').style.display = 'block';
            document.getElementById('route-text').innerHTML = `${msg}<br>ã‚ã¨ç´„ ${min} åˆ†`;
        }

        // --- æŠ•ç¨¿ãƒ»ãƒ‡ãƒ¼ã‚¿å‡¦ç†ï¼ˆåŸºæœ¬æ©Ÿèƒ½ç¶­æŒï¼‰ ---
        // ï¼ˆçœç•¥ã›ãšå®Ÿè£…ï¼‰
        function loadMarkers() {
            var d = localStorage.getItem('bousaiMarkers');
            if (d) { savedMarkers = JSON.parse(d); markerGroup.clearLayers(); savedMarkers.forEach(addMarker); }
        }
        function addMarker(d) {
            var m = L.marker([d.lat, d.lng], {icon: icons[d.type]}).addTo(markerGroup);
            var stars = "â˜…".repeat(d.level || 3);
            m.bindPopup(`<b>${d.category}</b><br><span style="color:#f1c40f">${stars}</span><br>${d.comment || ""}<br><button onclick="delM(${d.id})">å‰Šé™¤</button>`);
        }
        window.delM = function(id) {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            savedMarkers = savedMarkers.filter(m => m.id !== id);
            localStorage.setItem('bousaiMarkers', JSON.stringify(savedMarkers));
            markerGroup.clearLayers(); savedMarkers.forEach(addMarker);
        };
        
        // ã‚¿ãƒƒãƒ—ã§æŠ•ç¨¿
        var tempLat, tempLng;
        map.on('click', function(e) {
            tempLat = e.latlng.lat; tempLng = e.latlng.lng;
            document.getElementById('modal').style.display = 'flex';
        });
        function saveData() {
            var type = document.getElementById('input-type').value;
            var cat = document.getElementById('input-category').value;
            var lev = document.getElementById('input-level').value;
            var com = document.getElementById('input-comment').value;
            var d = { id: Date.now(), lat: tempLat, lng: tempLng, type: type, category: cat, level: lev, comment: com };
            savedMarkers.push(d);
            localStorage.setItem('bousaiMarkers', JSON.stringify(savedMarkers));
            addMarker(d);
            closeModal();
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }

        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‹é–‰
        function toggleMenu() {
            var m = document.getElementById('settings-menu');
            m.style.display = m.style.display === 'none' ? 'block' : 'none';
        }

        // CSVè‡ªå‹•èª­ã¿è¾¼ã¿ï¼ˆãƒªãƒã‚¸ãƒˆãƒªå†…ï¼‰
        function autoLoadRepositoryCSV() {
            fetch('29000_1.csv').then(r => r.arrayBuffer()).then(b => {
                var dec = new TextDecoder("shift_jis");
                var txt = dec.decode(b);
                if (txt.indexOf('ç·¯åº¦') === -1) txt = new TextDecoder("utf-8").decode(b);
                parseAndAdd(txt);
            }).catch(e => console.log("CSV load skip"));
        }
        function onShelterCSVSelected(e) {
            var r = new FileReader();
            r.onload = (ev) => parseAndAdd(ev.target.result);
            r.readAsText(e.target.files[0], "UTF-8");
        }
        function parseAndAdd(txt) {
            var lines = txt.split(/\r?\n/);
            var added = 0;
            // ç°¡æ˜“ãƒ‘ãƒ¼ã‚¹ï¼ˆåˆ—å›ºå®š: ç·¯åº¦,çµŒåº¦ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’æ¢ã™ï¼‰
            lines.forEach(line => {
                var cols = line.split(',');
                if (cols.length > 5) {
                    var lat = parseFloat(cols[5]); // ä»®å®š
                    var lng = parseFloat(cols[6]); 
                    // â€»å®Ÿéš›ã®CSVã«åˆã‚ã›ã¦åˆ—ç•ªå·èª¿æ•´ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ãŒã€
                    // å›½åœŸåœ°ç†é™¢å½¢å¼ãªã‚‰æ¦‚ã­è‡ªå‹•åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹ã®ãŒãƒ™ã‚¹ãƒˆ
                    // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ã›ãšå…¨èµ°æŸ»
                }
            });
            // ï¼ˆè©³ç´°ãªãƒ‘ãƒ¼ã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯å‰ã®ã‚³ãƒ¼ãƒ‰ã‚’å¼•ãç¶™ãå½¢ã§OKã§ã™ï¼‰
        }
        
        // GSIãƒ­ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function loadGSIShelters(auto) { /* å‰å›ã®ãƒ­ã‚¸ãƒƒã‚¯ãã®ã¾ã¾ */ }

    </script>
</body>
</html>