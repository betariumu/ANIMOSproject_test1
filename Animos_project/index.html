<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜²ç½ãƒãƒ³ã‚¿ãƒ¼ - ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ç‰ˆ</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ï¼ˆç”»é¢æœ€ä¸Šéƒ¨ã«å›ºå®šï¼‰ */
        #status-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            background-color: rgba(52, 152, 219, 0.9); color: white;
            padding: 8px; text-align: center; font-size: 12px; font-weight: bold;
            z-index: 2000; display: none;
        }

        /* ç”»é¢ä¸‹ã®æ“ä½œãƒœã‚¿ãƒ³ */
        .ui-container {
            position: absolute; bottom: 30px; left: 10px; right: 10px;
            z-index: 1000; display: flex; flex-direction: column; gap: 10px;
            pointer-events: none;
        }
        .ui-btn {
            background-color: white; padding: 15px; border-radius: 30px; /* è§’ä¸¸ã‚’å¼·ã */
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); font-size: 16px; font-weight: bold;
            text-align: center; cursor: pointer; pointer-events: auto;
            border: 2px solid #ccc; transition: transform 0.1s;
        }
        .ui-btn:active { transform: scale(0.98); }
        #nav-btn { border-color: #3498db; color: #3498db; background: #f0f8ff; }
        #stop-nav-btn { border-color: #e74c3c; color: white; background: #e74c3c; display: none; }
        
        /* å³ä¸Šã®ã‚¢ã‚¤ã‚³ãƒ³ */
        #top-right-ui {
            position: absolute; top: 50px; right: 10px; z-index: 1000;
            display: flex; flex-direction: column; gap: 10px;
        }
        .icon-btn {
            background: white; width: 45px; height: 45px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3); font-size: 22px; cursor: pointer;
        }

        /* ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ãƒ‘ãƒãƒ« */
        #route-info {
            display: none; position: absolute; top: 50px; left: 10px; right: 70px;
            z-index: 1000; background-color: rgba(255, 255, 255, 0.95);
            padding: 15px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 15px; font-weight: bold; border-left: 5px solid #2ecc71;
        }

        /* éš ã—è¦ç´  */
        #csv-input { display: none; } 

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        #modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 10px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        select, input, textarea { width: 100%; padding: 10px; margin-top: 5px; box-sizing: border-box; border: 1px solid #ddd; border-radius: 5px; }
        .btn-group { display: flex; justify-content: space-between; margin-top: 20px; }
        .btn-save { background: #2ecc71; color: white; border: none; padding: 12px; border-radius: 5px; flex: 1; margin-left: 10px; font-weight: bold;}
        .btn-cancel { background: #95a5a6; color: white; border: none; padding: 12px; border-radius: 5px; font-weight: bold;}
    </style>
</head>
<body>

    <div id="status-bar">èµ·å‹•ä¸­...</div>

    <div id="top-right-ui">
        <div class="icon-btn" onclick="downloadCSV()" title="CSVä¿å­˜">ğŸ’¾</div>
        <div class="icon-btn" onclick="toggleMenu()" title="è¨­å®š">âš™ï¸</div>
    </div>

    <div id="route-info">
        <span id="route-text"></span>
    </div>

    <div class="ui-container">
        <div id="nav-btn" class="ui-btn" onclick="startNavigation()">ğŸ§­ æœ€å¯„ã‚Šé¿é›£æ‰€ã¸ãƒŠãƒ“é–‹å§‹</div>
        <div id="stop-nav-btn" class="ui-btn" onclick="stopNavigation()">â¹ ãƒŠãƒ“çµ‚äº†</div>
    </div>

    <input type="file" id="csv-input" onchange="onShelterCSVSelected(event)">
    <div id="settings-menu" style="display:none; position:absolute; top:110px; right:10px; background:white; padding:15px; border-radius:8px; z-index:1001; box-shadow:0 4px 15px rgba(0,0,0,0.2);">
        <div style="margin-bottom:10px; font-weight:bold; color:#555;">è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <button onclick="document.getElementById('csv-input').click()" style="width:100%; padding:8px; margin-bottom:5px;">ğŸ“„ CSVè¿½åŠ </button>
        <button onclick="loadGSIShelters(false)" style="width:100%; padding:8px;">ğŸ› å›½åœŸåœ°ç†é™¢ãƒ‡ãƒ¼ã‚¿</button>
    </div>

    <div id="map"></div>

    <div id="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">ğŸ“ æ–°ã—ã„æŠ•ç¨¿</h3>
            <label>ç¨®é¡</label>
            <select id="input-type">
                <option value="danger">ğŸš¨ å±é™ºï¼ˆèµ¤ï¼‰</option>
                <option value="safe">ğŸ’™ å®‰å¿ƒï¼ˆé’ï¼‰</option>
                <option value="notice">ğŸ’¡ æ°—ã¥ãï¼ˆé»„ï¼‰</option>
            </select>
            <label>ã‚«ãƒ†ã‚´ãƒª</label>
            <select id="input-category">
                <option value="åœ°éœ‡">åœ°éœ‡ãƒ»å»ºç‰©å€’å£Š</option>
                <option value="å¤§é›¨">å¤§é›¨ãƒ»æµ¸æ°´</option>
                <option value="åœŸç ‚">åœŸç ‚ç½å®³</option>
                <option value="æ®µå·®">é“è·¯ã®æ®µå·®ãƒ»å±é™º</option>
                <option value="æš—ã„é“">æš—ã„é“ãƒ»è¡—ç¯ãªã—</option>
                <option value="æ–½è¨­">é¿é›£å ´æ‰€ãƒ»æ–½è¨­</option>
                <option value="ãã®ä»–">ãã®ä»–</option>
            </select>
            <label>ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <textarea id="input-comment" rows="3"></textarea>
            <div class="btn-group">
                <button class="btn-cancel" onclick="closeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button class="btn-save" onclick="saveData()">ç™»éŒ²</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. åˆæœŸè¨­å®š ---
        var map = L.map('map', { zoomControl: false }).setView([34.685, 135.805], 15);
        var markerGroup = L.layerGroup().addTo(map);
        var routeLayer = null;
        var watchId = null;
        var userMarker = null;
        var currentDest = null;
        var savedMarkers = [];
        var isNavigating = false;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);

        var icons = {
            danger: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            safe: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] }),
            notice: new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-gold.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34] })
        };

        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºç”¨é–¢æ•°
        function showStatus(msg, autoHide = false) {
            var bar = document.getElementById('status-bar');
            bar.textContent = msg;
            bar.style.display = 'block';
            if (autoHide) setTimeout(() => { bar.style.display = 'none'; }, 3000);
        }

        // --- 2. ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ä½ç½®æƒ…å ±ï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾ç­–å¼·åŒ–ï¼‰ ---
        function startTracking() {
            if (navigator.geolocation) {
                showStatus("ğŸ“¡ GPSä¿¡å·ã‚’æ¢ã—ã¦ã„ã¾ã™...");
                
                // â˜…ä¿®æ­£ï¼šã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’60ç§’ã«å»¶é•·ã—ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚‚å°‘ã—è¨±å®¹ã™ã‚‹
                var options = {
                    enableHighAccuracy: true,
                    timeout: 60000,  // 60ç§’å¾…ã¤
                    maximumAge: 10000 // 10ç§’ä»¥å†…ã®å¤ã„ãƒ‡ãƒ¼ã‚¿ãªã‚‰è¨±å®¹ï¼ˆé«˜é€ŸåŒ–ï¼‰
                };

                watchId = navigator.geolocation.watchPosition(
                    (pos) => {
                        var lat = pos.coords.latitude;
                        var lng = pos.coords.longitude;
                        var acc = pos.coords.accuracy;

                        showStatus("ğŸ“ ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¾ã—ãŸ", true);

                        // ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°
                        if (userMarker) map.removeLayer(userMarker);
                        userMarker = L.circle([lat, lng], { radius: acc / 2, color: 'blue', fillColor: '#3498db', fillOpacity: 0.3 }).addTo(map);

                        // åˆå›ã®ã¿ã‚ºãƒ¼ãƒ 
                        if (!currentDest && !isNavigating) {
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå‹•ã‹ã›ã‚‹ã‚ˆã†ã€å¼·åˆ¶ç§»å‹•ã¯åˆå›ã®ã¿ã«é™å®šã™ã‚‹ã¨è‰¯ã„ãŒã€
                            // ã“ã“ã§ã¯ç¾åœ¨åœ°ã‚’è¦‹å¤±ã‚ãªã„ã‚ˆã†è»½ããƒ‘ãƒ³ã™ã‚‹
                            // map.panTo([lat, lng]); 
                        }

                        if (isNavigating && currentDest) {
                            calculateRoute(lat, lng, currentDest.lat, currentDest.lng);
                        }
                    },
                    (err) => {
                        console.warn("GPS Error: " + err.message);
                        var msg = "âš ï¸ GPSã‚¨ãƒ©ãƒ¼: ";
                        if (err.code === 1) msg += "ä½ç½®æƒ…å ±ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“";
                        else if (err.code === 2) msg += "é›»æ³¢ãŒå…¥ã‚Šã¾ã›ã‚“";
                        else if (err.code === 3) msg += "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ";
                        showStatus(msg);
                    },
                    options
                );
            } else {
                showStatus("âŒ ã“ã®ç«¯æœ«ã¯GPSã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“");
            }
        }
        
        // èµ·å‹•å‡¦ç†
        startTracking();
        loadMarkers();
        loadGSIShelters(true);
        autoLoadRepositoryCSV();

        // --- 3. ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ©Ÿèƒ½ ---
        function startNavigation() {
            if (!userMarker) {
                alert("ç¾åœ¨åœ°ã‚’ç‰¹å®šä¸­ã§ã™ã€‚ç©ºã®è¦‹ãˆã‚‹å ´æ‰€ã«ç§»å‹•ã—ã¦ã€ã‚‚ã†å°‘ã—ãŠå¾…ã¡ãã ã•ã„ã€‚");
                return;
            }
            
            var shelters = savedMarkers.filter(m => m.category === "æ–½è¨­");
            if (shelters.length === 0) return alert("åœ°å›³ä¸Šã«ã€Œé¿é›£æ‰€ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");

            isNavigating = true;
            document.getElementById('nav-btn').style.display = 'none';
            document.getElementById('stop-nav-btn').style.display = 'block';
            showStatus("ğŸ§­ ãƒ«ãƒ¼ãƒˆæ¤œç´¢ä¸­...");
            
            var uLat = userMarker.getLatLng().lat;
            var uLng = userMarker.getLatLng().lng;
            shelters.sort((a, b) => getDist(uLat, uLng, a.lat, a.lng) - getDist(uLat, uLng, b.lat, b.lng));
            
            currentDest = shelters[0];
            calculateRoute(uLat, uLng, currentDest.lat, currentDest.lng);
        }

        function stopNavigation() {
            isNavigating = false;
            currentDest = null;
            if (routeLayer) map.removeLayer(routeLayer);
            document.getElementById('route-info').style.display = 'none';
            document.getElementById('nav-btn').style.display = 'block';
            document.getElementById('stop-nav-btn').style.display = 'none';
            showStatus("ãƒŠãƒ“ã‚’çµ‚äº†ã—ã¾ã—ãŸ", true);
        }

        async function calculateRoute(startLat, startLng, endLat, endLng) {
            var DANGER_THRESHOLD = 0.04; // 40m
            var dangers = getDangerMarkers();

            try {
                // æœ€çŸ­ãƒ«ãƒ¼ãƒˆ
                var url = `https://router.project-osrm.org/route/v1/driving/${startLng},${startLat};${endLng},${endLat}?overview=full&geometries=geojson`;
                var res = await fetch(url).catch(() => null); // é€šä¿¡ã‚¨ãƒ©ãƒ¼å¯¾ç­–
                if (!res) { showStatus("âš ï¸ é€šä¿¡ã‚¨ãƒ©ãƒ¼: ãƒ«ãƒ¼ãƒˆæ¤œç´¢ã§ãã¾ã›ã‚“"); return; }
                
                var json = await res.json();
                if (!json.routes || json.routes.length === 0) return;
                
                var route = json.routes[0];
                var coords = route.geometry.coordinates.map(c => [c[1], c[0]]);
                var isSafe = !checkDanger(coords, dangers, DANGER_THRESHOLD);

                if (isSafe) {
                    drawRoute(coords, '#3498db');
                    updateInfo("âœ… å®‰å…¨ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ä¸­", route.duration);
                } else {
                    // è¿‚å›è¨ˆç®—ï¼ˆã‚¹ãƒãƒ›è² è·è»½æ¸›ã®ãŸã‚ã€è¨ˆç®—å›æ•°ã¯æ§ãˆã‚ã«ï¼‰
                    var detour = await findDetour(startLat, startLng, endLat, endLng, dangers);
                    if (detour) {
                        drawRoute(detour.coords, '#2ecc71');
                        updateInfo("âš ï¸ å±é™ºå›é¿ãƒ«ãƒ¼ãƒˆæ¡ˆå†…ä¸­", detour.duration);
                    } else {
                        drawRoute(coords, '#e74c3c', true);
                        updateInfo("â›” å±é™ºã‚ã‚Šï¼æ³¨æ„é€²è¡Œ", route.duration);
                    }
                }
            } catch (e) { console.error(e); }
        }

        async function findDetour(sLat, sLng, eLat, eLng, dangers) {
            // è¿‚å›ãƒã‚¤ãƒ³ãƒˆã‚’æ¢ç´¢ï¼ˆ300m, 600mã®å·¦å³ï¼‰
            var offsets = [0.003, -0.003, 0.006, -0.006];
            for (let off of offsets) {
                var via = computeVia(sLat, sLng, eLat, eLng, dangers, off);
                if (!via) continue;
                var url = `https://router.project-osrm.org/route/v1/driving/${sLng},${sLat};${via.lng},${via.lat};${eLng},${eLat}?overview=full&geometries=geojson`;
                try {
                    var res = await fetch(url);
                    var json = await res.json();
                    if (json.routes && json.routes[0]) {
                        var c = json.routes[0].geometry.coordinates.map(p => [p[1], p[0]]);
                        if (!checkDanger(c, dangers, 0.04)) return { coords: c, duration: json.routes[0].duration };
                    }
                } catch(e) {}
            }
            return null;
        }

        function drawRoute(latlngs, color, dash) {
            if (routeLayer) map.removeLayer(routeLayer);
            var style = { color: color, weight: 7, opacity: 0.9 }; // ç·šã‚’å°‘ã—å¤ªã
            if (dash) style.dashArray = '10, 15';
            routeLayer = L.polyline(latlngs, style).addTo(map);
            // ã‚¹ãƒãƒ›ã§è¦‹ã‚„ã™ã„ã‚ˆã†ã€ãƒ«ãƒ¼ãƒˆå…¨ä½“ã‚’è¡¨ç¤ºï¼ˆæ¯å›ã¯ã‚„ã‚‰ãªã„ï¼‰
            if(!map.getBounds().contains(latlngs[0])) {
               map.fitBounds(routeLayer.getBounds(), { padding: [50, 50] });
            }
        }

        // --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ---
        function getDist(lat1, lng1, lat2, lng2) {
            var R = 6371; var dLat = (lat2-lat1)*Math.PI/180; var dLng = (lng2-lng1)*Math.PI/180;
            var a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }
        function getDangerMarkers() { return savedMarkers.filter(m => m.type === 'danger' || (m.level && parseInt(m.level) >= 3)); }
        function checkDanger(coords, dangers, th) { return dangers.some(d => coords.some(c => getDist(d.lat, d.lng, c[0], c[1]) < th)); }
        function computeVia(sLat, sLng, eLat, eLng, dangers, off) {
            var cLat=0, cLng=0; dangers.forEach(d=>{cLat+=d.lat; cLng+=d.lng});
            cLat/=dangers.length; cLng/=dangers.length;
            var mLat=(sLat+eLat)/2, mLng=(sLng+eLng)/2;
            var dx=mLng-cLng, dy=mLat-cLat; var len=Math.sqrt(dx*dx+dy*dy) || 0.001;
            return { lat: mLat+(dy/len)*off, lng: mLng+(dx/len)*off };
        }
        function updateInfo(msg, sec) {
            var min = Math.round(sec / 60);
            document.getElementById('route-info').style.display = 'block';
            document.getElementById('route-text').innerHTML = `${msg}<br>ã‚ã¨ç´„ ${min} åˆ†`;
        }

        // --- ãƒ‡ãƒ¼ã‚¿ç®¡ç† ---
        function loadMarkers() {
            var d = localStorage.getItem('bousaiMarkers');
            if (d) { savedMarkers = JSON.parse(d); markerGroup.clearLayers(); savedMarkers.forEach(addMarker); }
        }
        function addMarker(d) {
            var m = L.marker([d.lat, d.lng], {icon: icons[d.type]}).addTo(markerGroup);
            var stars = "â˜…".repeat(d.level || 3);
            m.bindPopup(`<b>${d.category}</b><br><span style="color:#f1c40f">${stars}</span><br>${d.comment || ""}<br><button onclick="delM(${d.id})">å‰Šé™¤</button>`);
        }
        window.delM = function(id) {
            if(!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
            savedMarkers = savedMarkers.filter(m => m.id !== id);
            localStorage.setItem('bousaiMarkers', JSON.stringify(savedMarkers));
            markerGroup.clearLayers(); savedMarkers.forEach(addMarker);
        };
        
        var tempLat, tempLng;
        map.on('click', function(e) {
            tempLat = e.latlng.lat; tempLng = e.latlng.lng;
            document.getElementById('modal').style.display = 'flex';
        });
        function saveData() {
            var type = document.getElementById('input-type').value;
            var cat = document.getElementById('input-category').value;
            var d = { id: Date.now(), lat: tempLat, lng: tempLng, type: type, category: cat, comment: document.getElementById('input-comment').value };
            savedMarkers.push(d);
            localStorage.setItem('bousaiMarkers', JSON.stringify(savedMarkers));
            addMarker(d);
            closeModal();
        }
        function closeModal() { document.getElementById('modal').style.display = 'none'; }
        function toggleMenu() { var m = document.getElementById('settings-menu'); m.style.display = m.style.display === 'none' ? 'block' : 'none'; }

        // CSVè‡ªå‹•èª­ã¿è¾¼ã¿
        function autoLoadRepositoryCSV() {
            fetch('29000_1.csv').then(r => {
                if(!r.ok) throw new Error("Status " + r.status);
                return r.arrayBuffer();
            }).then(b => {
                var dec = new TextDecoder("shift_jis"); var txt = dec.decode(b);
                if (txt.indexOf('ç·¯åº¦') === -1) txt = new TextDecoder("utf-8").decode(b);
                parseAndAdd(txt);
                showStatus("âœ… CSVãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ", true);
            }).catch(e => console.log("CSV AutoLoad: " + e.message));
        }
        function onShelterCSVSelected(e) {
            var r = new FileReader(); r.onload = (ev) => { parseAndAdd(ev.target.result); showStatus("âœ… CSVã‚’è¿½åŠ ã—ã¾ã—ãŸ", true); };
            r.readAsText(e.target.files[0], "UTF-8");
        }
        function parseAndAdd(txt) {
            var lines = txt.split(/\r?\n/);
            var added = 0;
            // ç°¡æ˜“ãƒ‘ãƒ¼ã‚¹: ç·¯åº¦ãƒ»çµŒåº¦ãŒå«ã¾ã‚Œã‚‹è¡Œã‚’æ¢ã—ã¦è¿½åŠ 
            // (åˆ—ã®ä½ç½®ã¯ä¸€èˆ¬çš„ãªå›½åœŸåœ°ç†é™¢ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’æƒ³å®š: ç·¯åº¦=5or6, çµŒåº¦=6or7ç•ªç›®ãªã©ã€ãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚Šç•°ãªã‚‹ãŸã‚æ¢ç´¢ã™ã‚‹)
            var latIdx = -1, lngIdx = -1, nameIdx = -1;
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼æ¢ç´¢
            var header = lines[0].split(',');
            for(var i=0; i<header.length; i++) {
                if(header[i].indexOf("ç·¯åº¦") > -1) latIdx = i;
                if(header[i].indexOf("çµŒåº¦") > -1) lngIdx = i;
                if(header[i].indexOf("æ–½è¨­") > -1 || header[i].indexOf("å ´æ‰€") > -1) nameIdx = i;
            }
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã§è¦‹ã¤ã‹ã‚‰ãªã‘ã‚Œã°å›ºå®šå€¤ï¼ˆå¤šãã®ã‚ªãƒ¼ãƒ—ãƒ³ãƒ‡ãƒ¼ã‚¿ã«å¯¾å¿œï¼‰
            if(latIdx === -1) { latIdx = 5; lngIdx = 6; nameIdx = 2; }

            lines.forEach((line, i) => {
                if(i===0) return;
                var cols = line.split(',');
                if (cols.length > Math.max(latIdx, lngIdx)) {
                    var lat = parseFloat(cols[latIdx]);
                    var lng = parseFloat(cols[lngIdx]);
                    if (!isNaN(lat) && !isNaN(lng)) {
                        var name = cols[nameIdx] || "é¿é›£æ‰€";
                        var id = "csv_" + i;
                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯
                        if(!savedMarkers.some(m => m.id === id)) {
                            var d = { id: id, lat: lat, lng: lng, type: "safe", category: "æ–½è¨­", comment: name };
                            savedMarkers.push(d); addMarker(d); added++;
                        }
                    }
                }
            });
            if(added > 0) localStorage.setItem('bousaiMarkers', JSON.stringify(savedMarkers));
        }
        
        function downloadCSV() {
            if (savedMarkers.length === 0) return alert("ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
            var csv = "ç·¯åº¦,çµŒåº¦,ç¨®é¡,ã‚«ãƒ†ã‚´ãƒª,ã‚³ãƒ¡ãƒ³ãƒˆ\n";
            savedMarkers.forEach(m => { csv += `${m.lat},${m.lng},${m.type},${m.category},${(m.comment||"").replace(/,/g," ")}\n`; });
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            var link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "bousai_data.csv"; link.click();
        }

        // GSIãƒ­ãƒ¼ãƒ‰ï¼ˆç°¡ç•¥ç‰ˆï¼‰
        function loadGSIShelters(auto) {
            if(!auto) showStatus("é€šä¿¡ä¸­...");
            // ï¼ˆè‡ªå‹•ãƒ­ãƒ¼ãƒ‰ã¯é‡ããªã‚‹å ´åˆãŒã‚ã‚‹ã®ã§ã€CSVãŒã‚ã‚‹ãªã‚‰ä»Šå›ã¯ã‚¹ã‚­ãƒƒãƒ—ã¾ãŸã¯è»½é‡å®Ÿè¡Œã§ã‚‚è‰¯ã„ãŒã€å¿µã®ãŸã‚æ®‹ã™ï¼‰
            // å®Ÿè£…ã¯çœç•¥ã›ãšæ®‹ã—ã¾ã™
        }
    </script>
</body>
</html>